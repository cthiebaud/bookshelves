<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 
        <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    -->
    <title>3D Scatter Plot from Image</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@latest/dist/css/bootstrap.min.css">
    <style>
        /*
            + leftCol - - - - - - - - + - - - - - - - -rightCol +
            |                         |                         |
            |                         |                         |
            |                         |                         |
            |              + img1- - +|+ img2- - +              |
            |              |         ||          |              |
            |              |         ||          |              |
            |              + - - - - +|+ - - - - +              |
            + - - - - - - - - - - - - + - - - - - - - - - - - - +

            + leftCol - - - - - - - - +
            |                         |
            |                         |
            |                         |
            |              + img1- - +|
            |              |         ||
            |              |         ||
            |              + - - - - +|
            + - - - - - - - - - - - - +
            + - - - - - - - -rightCol +
            |              + img2- - +|
            |              |         ||
            |              |         ||
            |              + - - - - +|
            |                         |
            |                         |
            |                         |
            + - - - - - - - - - - - - +
        */
        body {
            margin: 0;
        }

        .leftCol {
            position: relative;
            align-items: flex-start;
            border-right: .5px dotted gray;
        }

        .rightCol {
            position: relative;
            align-items: flex-end;
            border-left: .5px dotted gray;
        }

        .graph-container {
            position: relative;
            flex: 1;
            width: 80%;
        }

        .leftCol .graph-container {
            margin-left: 0;
            margin-right: auto;
        }

        .rightCol .graph-container {
            margin-left: auto;
            margin-right: 0;
        }

        .graph {
            width: 100%;
            height: 100%;
        }

        .image-overlay {
            position: absolute;
            margin: 0.5rem;
            width: 25%;
            height: auto;
        }

        .image-overlay-left {
            left: 0;
            bottom: 0;
        }

        .image-overlay-right {
            right: 0;
            bottom: 0;
        }

        @media (max-width: 1140px) {
            .image-overlay-left {
                top: 0;
                right: 0;
                left: auto;
                bottom: auto;
            }

            .rightCol .graph-container {
                margin-left: 0;
                margin-right: auto;
            }
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100px;
            height: 100px;
            z-index: 12;
        }
    </style>

</head>

<body>

    <div id="loading">
        <svg xmlns="http://www.w3.org/2000/svg" xml:space="preserve" viewBox="0 0 473.068 473.068">
            <path
                d="M355.507 181.955c8.793-6.139 29.39-20.519 29.39-55.351v-71.77h9.814c4.49 0 8.17-3.679 8.17-8.169v-38.5c0-4.49-3.681-8.165-8.17-8.165H78.351c-4.495 0-8.165 3.675-8.165 8.165v38.5c0 4.491 3.67 8.169 8.165 8.169h9.82v73.071c0 34.499 10.502 42.576 29.074 53.89l80.745 49.203v20.984c-20.346 12.23-73.465 44.242-80.434 49.107-8.793 6.135-29.384 20.51-29.384 55.352v61.793h-9.82c-4.495 0-8.165 3.676-8.165 8.166v38.498c0 4.49 3.67 8.17 8.165 8.17h316.361c4.49 0 8.17-3.68 8.17-8.17V426.4c0-4.49-3.681-8.166-8.17-8.166h-9.814V355.13c0-34.493-10.508-42.572-29.069-53.885l-80.745-49.202v-20.987c20.332-12.225 73.452-44.234 80.422-49.101zm-102.781 90.904 87.802 53.5c6.734 4.109 10.333 6.373 12.001 9.002 1.991 3.164 2.963 9.627 2.963 19.768v63.104H117.574V356.44c0-19.507 9.718-26.289 16.81-31.242 5.551-3.865 54.402-33.389 85.878-52.289a14.701 14.701 0 0 0 7.135-12.611v-37.563c0-5.123-2.671-9.883-7.053-12.55l-87.54-53.339-.265-.165c-6.741-4.105-10.336-6.369-11.998-9.009-1.992-3.156-2.968-9.626-2.968-19.767v-73.07h237.918v71.77c0 19.5-9.718 26.288-16.814 31.235-5.546 3.872-54.391 33.395-85.869 52.295a14.7 14.7 0 0 0-7.134 12.601v37.563a14.71 14.71 0 0 0 7.052 12.56z" />
            <path
                d="M331.065 154.234s5.291-4.619-2.801-3.299c-19.178 3.115-53.079 15.133-92.079 15.133s-57-11-82.507-11.303c-5.569-.066-5.456 3.629.937 7.391 6.386 3.758 63.772 35.681 71.671 40.08 7.896 4.389 12.417 4.05 20.786 0 12.174-5.902 83.993-48.002 83.993-48.002zm-176.754 243.33c-6.748 6.209-9.978 10.713 5.536 10.713h155.442c16.099 0 9.856-5.453 2.311-12.643-14.576-13.883-45.416-23.566-82.414-23.566-38.754 0-65.844 11.655-80.875 25.496z" />
        </svg>
    </div>

    <div class="container-xl">
        <div class="row mt-3">
            <style>
                .advance {
                    visibility: hidden;
                }

                .advance.visible {
                    visibility: visible;
                }
            </style>
            <div class="col">
                <button id="advanceButton1" class="btn btn-light advance">show plot</button>
                &raquo;
                <button id="advanceButton2" class="btn btn-light advance">show regression plane</button>
                &raquo;
                <button id="advanceButton3" class="btn btn-light advance">show flat plot</button>
                &raquo;
                <button id="advanceButton4" class="btn btn-light advance">show flat image</button>
            </div>
        </div>
        <div class="row" style="width: 100%; height: 40vh;">
            <!-- First Column -->
            <div id="leftCol1" class="col-xl-6 leftCol">
                &nbsp;
                <div class="graph-container">
                    <!-- Plotly Graph -->
                    <div class="graph" id="scatter-plot-container">
                        <div id="scatter-plot"></div>
                    </div>
                </div>
                <!-- Image in the top-right corner -->
                <a href="/"><img id="image-display" class="image-overlay image-overlay-right" /></a>
            </div>

            <!-- Second Column -->
            <div id="rightCol1" class="col-xl-6 justify-content-end rightCol">
                &nbsp;
                <div class="graph-container">
                    <!-- Plotly Graph -->
                    <div class="graph" id="scatter-plot2-container">
                        <div id="scatter-plot2"></div>
                    </div>
                </div>
                <!-- Image in the top-left corner -->
                <img id="generated-image" class="image-overlay image-overlay-left" />
            </div>
        </div>
        <!-- 

            <div class="row" style="width: 100%; height: 40vh;">
                <div id="leftCol2" class="col-xl-6 leftCol">
                    <div class="graph-container" style="width: 100%">
                        <div class="graph" id="scatter-surface-container">
                            <div id="scatter-surface"></div>
                        </div>
                    </div>
                </div>
                <div id="rightCol2" class="col-xl-6 justify-content-end rightCol">
                    <div class="graph-container" style="width: 100%">
                        <div class="graph" id="scatter-plot3-container">
                            <div id="scatter-plot3"></div>
                        </div>
                        <img id="generated-image2" class="image-overlay image-overlay-left" />
                    </div>
                </div>
            </div>
        -->
    </div>
    <script src="https://cdn.jsdelivr.net/npm/plotly.js@latest/dist/plotly.min.js"></script>
    <!-- 
        <script src="https://cdn.jsdelivr.net/npm/default-passive-events@latest/dist/index.min.js"></script>
    -->
    <script type="module">
        // main.js
        import { orthographicProjection, orthographicProjectionSet } from './vectorOperations.js';
        import { extractPlaneInfo, orthographicProjectionOnLine } from './planeOperations.js';
        import glob from './singletonModule.js';

        const advanceButtons = Array.from(document.getElementsByClassName('advance'))

        function arrayToXYZObject(arr) {
            return { x: arr[0], y: arr[1], z: arr[2] };
        }
        function XYZObjectToArray(obj) {
            return [obj.x, obj.y, obj.z];
        }

        function _coerce_(w, min = glob.MIN, max = glob.MAX) {
            if (w < min) {
                return min
            }
            if (max < w) {
                return max - glob.EPSILON
            }
            return w
        }

        // Function to load the image and create 3D scatter plot with Plotly
        function createScatterPlotFromImage(imagePath) {
            const loadingElement = document.getElementById('loading');
            const imageDisplay = document.getElementById('image-display');

            imageDisplay.onload = function () {

                if (!glob.width || !glob.height) {
                    glob.width = imageDisplay.width;
                    glob.height = imageDisplay.height;
                }

                // Create a single canvas element and draw the image once
                const canvas = document.createElement('canvas');
                canvas.width = glob.width;
                canvas.height = glob.height;
                const ctx = canvas.getContext('2d', { willReadFrequently: true });
                ctx.drawImage(this, 0, 0, glob.width, glob.height);

                const data3d = {
                    x: [],
                    y: [],
                    z: [],
                    mode: 'markers',
                    type: 'scatter3d',
                    showlegend: false,
                    showscale: false,
                    hoverinfo: "none",
                    hovermode: false,
                    marker: {
                        size: 4,
                        color: [],      // Array to store colors for each point
                        opacity: 0.80,  // Set opacity for every point
                    },
                };

                // Loop through all pixels and sample pixel data
                for (let y = 0; y < glob.height; y++) {
                    for (let x = 0; x < glob.width; x++) {
                        // Sample pixel data from the drawn image
                        const pixel = ctx.getImageData(x, y, 1, 1).data;

                        // Add coordinates to the single trace
                        data3d.x.push(pixel[0]);  // Red component as x
                        data3d.y.push(pixel[1]);  // Green component as y
                        data3d.z.push(pixel[2]);  // Blue component as z

                        // Add color for each point
                        data3d.marker.color.push(`rgb(${pixel[0]}, ${pixel[1]}, ${pixel[2]})`);
                    }
                }

                const layout = {
                    scene: {
                        aspectmode: 'cube',
                        xaxis: { autorange: false, title: 'X Red' },
                        yaxis: { autorange: false, title: 'Y Green' },
                        zaxis: { autorange: false, title: 'Z Blue' },
                    },
                    showlegend: false,
                    showscale: false,
                    hoverinfo: "none",
                    hovermode: false,
                    margin: {
                        l: 0,
                        r: 0,
                        t: 0,
                        b: 0
                    }
                };

                for (const property in layout.scene) {
                    if (!['xaxis', 'yaxis', 'zaxis'].includes(property)) continue;
                    layout.scene[property].range = [glob.MIN, glob.MAX]
                    layout.scene[property]["tickvals"] = [glob.MIN, glob.MAX / 4 - 1, glob.MAX / 2 - 1, 3 * glob.MAX / 4 - 1, glob.MAX - 1]
                    layout.scene[property]["ticktext"] = layout.scene[property]["tickvals"].map(tickval => tickval.toString(16).padStart(2, '0').toUpperCase())
                }

                // Display the 3D scatter plot
                Plotly.newPlot('scatter-plot', [data3d], layout, { displayModeBar: false }).then(function () {
                    /* const plotSvgContainer = document.querySelector('#scatter-plot .svg-container');

                    // Apply custom styles to right-align the canvas
                    plotSvgContainer.style.marginLeft = '0';
                    plotSvgContainer.style.marginRight = 'auto'; */

                    loadingElement.style.display = 'none'
                    advanceButtons.forEach((e) => e.classList.add('visible'))

                    // Fetch the multiple linear regression plane from the server
                    const url = 'http://localhost:4321/perform_regression'
                    fetch(url, {
                        method: 'POST',
                        mode: "cors",
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ X1: data3d.x, X2: data3d.y, Y: data3d.z }),
                    }).then(response => response.json()).then(results => {
                        console.log(results)
                        const regressionPlane = {
                            x: results.meshgrid.X1,
                            y: results.meshgrid.X2,
                            z: results.meshgrid.Y,
                            type: 'surface',
                            opacity: 0.3,
                            colorscale: 'Greens',
                            showlegend: false,
                            showscale: false,
                            hoverinfo: "none",
                            hovermode: false,
                            visible: false,
                            name: 'regression-plane'
                        };

                        Plotly.addTraces('scatter-plot', regressionPlane);

                        // Create a new canvas to draw the generated image
                        const generatedCanvas = document.createElement('canvas');
                        generatedCanvas.width = glob.width;
                        generatedCanvas.height = glob.height;
                        const generatedCtx = generatedCanvas.getContext('2d', { willReadFrequently: true });

                        // Create a new ImageData object to hold the pixel data
                        const imageData = generatedCtx.createImageData(glob.width, glob.height);

                        const planeInfo = extractPlaneInfo(results.coefficients.coef_X1, results.coefficients.coef_X2, -1, results.coefficients.intercept)

                        // Create a second scatter plot with projected and coerced z-coordinates
                        const projectedCoercedScatter = {
                            x: [],
                            y: [],
                            z: [],
                            mode: 'markers',
                            type: 'scatter3d',
                            marker: {
                                size: 4,
                                color: [],  // Array to store colors for each point
                                opacity: 0.80,
                            },
                            hoverinfo: 'none'
                        };

                        const projecteds = orthographicProjectionSet(
                            data3d,
                            planeInfo.planeNormal,
                            planeInfo.planePoint
                        )

                        // converts the array of points to separate array for each x, y, z coordinates
                        /*
                        from 
                        [[x1,y1,z1],[x2,y2,z2],...]
                        to
                        {x: [x1,x2,...],y: [y1,y2,...], z:...}
                        */
                        function convertToPointsObject(projecteds) {
                            const transposedProjections = projecteds[0].map((_, i) =>
                                projecteds.map(projection => projection[i])
                            );

                            return {
                                x: transposedProjections[0],
                                y: transposedProjections[1],
                                z: transposedProjections[2]
                            };
                        }
                        const projectedsAsPoints = convertToPointsObject(projecteds);

                        // coerce projections to [0, 256)
                        projectedCoercedScatter.x = projectedsAsPoints.x.map(x => _coerce_(x))
                        projectedCoercedScatter.y = projectedsAsPoints.y.map(y => _coerce_(y))
                        projectedCoercedScatter.z = projectedsAsPoints.z.map(z => _coerce_(z))

                        // Loop through the projectedCoercedScatter data to set the RGB values for each pixel
                        let altered = 0
                        let wrongs = 0
                        for (let i = 0; i < projecteds.length; i++) {

                            const x = projectedCoercedScatter.x[i]
                            const y = projectedCoercedScatter.y[i]
                            const z = projectedCoercedScatter.z[i]

                            if (x !== projectedsAsPoints.x[i] ||
                                y !== projectedsAsPoints.y[i] ||
                                z !== projectedsAsPoints.z[i]) {
                                /*
                                console.log(`rgb(${projectedsAsPoints.x[i]}, ${projectedsAsPoints.y[i]}, ${projectedsAsPoints.z[i]}) ORIGINAL...`)
                                console.log(`rgb(${x}, ${y}, ${z}) ...ALTERED !!!`)
                                */
                                altered++
                            }

                            if (x < 0 || y < 0 || z < 0 || x >= 256 || y >= 256 || z >= 256) {
                                console.log(`rgb(${x}, ${y}, ${z}) WRONG !!!`)
                                wrongs++
                            }

                            projectedCoercedScatter.marker.color.push(`rgb(${x}, ${y}, ${z})`);

                            // Calculate the index in the ImageData array
                            const index = i * 4;

                            // Set the RGB values for the pixel directly from projectedCoercedScatter.z
                            imageData.data[index] = (x)        //  & 0xFF; // Red
                            imageData.data[index + 1] = (y)    //  & 0xFF; // Green
                            imageData.data[index + 2] = (z)    //  & 0xFF; // Blue
                            imageData.data[index + 3] = 255; // Alpha value, 255 for fully opaque
                        }
                        console.log(`altered: ${altered} out of ${projecteds.length}`)
                        console.log(`wrongs: ${wrongs} out of ${projecteds.length}`)

                        Plotly.newPlot('scatter-plot2', [projectedCoercedScatter], layout, { displayModeBar: false }).then(function () {
                            /* const plot2SvgContainer = document.querySelector('#scatter-plot2 .svg-container');

                            // Apply custom styles to right-align the canvas
                            plot2SvgContainer.style.marginLeft = 'auto';
                            plot2SvgContainer.style.marginRight = '0';
                            */

                            // Put the generated pixel data onto the canvas
                            generatedCtx.putImageData(imageData, 0, 0);

                            // Set the generated image as the source of the img element
                            const generatedImage = document.getElementById('generated-image');
                            generatedImage.src = generatedCanvas.toDataURL();
                        })
                    })

                })
            }

            imageDisplay.src = imagePath
        }

        // Function to show or hide elements based on the current step
        function updateAdvanceButtons(step) {
            advanceButtons.forEach(b => {
                b.disabled = true
                b.classList.add('btn-light')
            })
            if (step < advanceButtons.length) {
                const thisButton = advanceButtons[step]
                thisButton.disabled = false
                thisButton.addEventListener('click', handleInteraction)
                thisButton.classList.remove('btn-light')
                thisButton.classList.add('btn-secondary')
            }
        }

        // Function to show or hide elements based on the current step
        function updateSlideShow(step) {
            const scatterPlotContainer = document.getElementById('scatter-plot-container');
            const scatterPlot2Container = document.getElementById('scatter-plot2-container');
            const imageLink = document.getElementById('generated-image');

            updateAdvanceButtons(step)

            // Show elements based on the current step
            switch (step) {
                case 0:
                    // Hide all elements 
                    scatterPlotContainer.style.display = 'none';
                    scatterPlot2Container.style.display = 'none';
                    imageLink.style.display = 'none';

                    return step + 1;
                    break;

                case 1:
                    scatterPlotContainer.style.display = 'block';
                    return step + 1;

                case 2:
                    const scatterPlot = document.getElementById('scatter-plot');
                    const allTraces = scatterPlot.data;

                    // Find index of trace-object with "name" property  = "text to find":
                    const regressionPlane = allTraces.findIndex(obj => obj.name === 'regression-plane');

                    // Make specified trace visible to the user:
                    Plotly.restyle(scatterPlot, { "visible": true }, [regressionPlane]);
                    return step + 1;

                case 3:
                    scatterPlot2Container.style.display = 'block';
                    return step + 1;

                case 4:
                    imageLink.style.display = 'block';
                    return step + 1;

                default:
                    return step;
            }
        }

        let currentStep = 0;

        // Function to handle key events and button click
        function handleInteraction(e) {
            if (event.target.disabled) {
                return
            }
            currentStep = updateSlideShow(currentStep)

        }

        // Attach key event listener to the document
        document.addEventListener('keypress', handleInteraction);

        // Initial state of the slideshow
        currentStep = updateSlideShow(currentStep);

        // Load the image and create the scatter plot when the DOM is ready
        document.addEventListener('DOMContentLoaded', function () {
            const queryParams = new URLSearchParams(window.location.search);
            const imagePathFromQueryString = queryParams.get('image');

            if (imagePathFromQueryString) {
                createScatterPlotFromImage(imagePathFromQueryString);
            } else {
                console.error('Image path not provided in the query string.');
            }
        });

        // Resize the plot when the window is resized
        window.addEventListener('resize', function () {
            Plotly.Plots.resize('scatter-plot');
            Plotly.Plots.resize('scatter-plot2');
        });
    </script>

</body>

</html>