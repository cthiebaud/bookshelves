<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <title>3D Scatter Plot from Image</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }

        #scatter-plot {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
        }

        #image-display {
            position: absolute;
            top: 0;
            left: 0;
            margin: 20px;
            max-width: 30%;
            /* Adjust the maximum width of the image */
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100px;
            height: 100px;
            z-index: 12;
        }
    </style>
</head>

<body>

    <div id="loading">
        <svg xmlns="http://www.w3.org/2000/svg" xml:space="preserve" viewBox="0 0 473.068 473.068">
            <path
                d="M355.507 181.955c8.793-6.139 29.39-20.519 29.39-55.351v-71.77h9.814c4.49 0 8.17-3.679 8.17-8.169v-38.5c0-4.49-3.681-8.165-8.17-8.165H78.351c-4.495 0-8.165 3.675-8.165 8.165v38.5c0 4.491 3.67 8.169 8.165 8.169h9.82v73.071c0 34.499 10.502 42.576 29.074 53.89l80.745 49.203v20.984c-20.346 12.23-73.465 44.242-80.434 49.107-8.793 6.135-29.384 20.51-29.384 55.352v61.793h-9.82c-4.495 0-8.165 3.676-8.165 8.166v38.498c0 4.49 3.67 8.17 8.165 8.17h316.361c4.49 0 8.17-3.68 8.17-8.17V426.4c0-4.49-3.681-8.166-8.17-8.166h-9.814V355.13c0-34.493-10.508-42.572-29.069-53.885l-80.745-49.202v-20.987c20.332-12.225 73.452-44.234 80.422-49.101zm-102.781 90.904 87.802 53.5c6.734 4.109 10.333 6.373 12.001 9.002 1.991 3.164 2.963 9.627 2.963 19.768v63.104H117.574V356.44c0-19.507 9.718-26.289 16.81-31.242 5.551-3.865 54.402-33.389 85.878-52.289a14.701 14.701 0 0 0 7.135-12.611v-37.563c0-5.123-2.671-9.883-7.053-12.55l-87.54-53.339-.265-.165c-6.741-4.105-10.336-6.369-11.998-9.009-1.992-3.156-2.968-9.626-2.968-19.767v-73.07h237.918v71.77c0 19.5-9.718 26.288-16.814 31.235-5.546 3.872-54.391 33.395-85.869 52.295a14.7 14.7 0 0 0-7.134 12.601v37.563a14.71 14.71 0 0 0 7.052 12.56z" />
            <path
                d="M331.065 154.234s5.291-4.619-2.801-3.299c-19.178 3.115-53.079 15.133-92.079 15.133s-57-11-82.507-11.303c-5.569-.066-5.456 3.629.937 7.391 6.386 3.758 63.772 35.681 71.671 40.08 7.896 4.389 12.417 4.05 20.786 0 12.174-5.902 83.993-48.002 83.993-48.002zm-176.754 243.33c-6.748 6.209-9.978 10.713 5.536 10.713h155.442c16.099 0 9.856-5.453 2.311-12.643-14.576-13.883-45.416-23.566-82.414-23.566-38.754 0-65.844 11.655-80.875 25.496z" />
        </svg>
    </div>

    <div id="scatter-plot"></div>
    <img id="image-display" />

    <script>
        // Function to load the image and create 3D scatter plot with Plotly
        function createScatterPlotFromImage(imagePath, width, height) {
            const loadingElement = document.getElementById('loading');
            const img = new Image();

            img.onload = function () {
                // Display the image
                function showImage() {

                    const imageDisplay = document.getElementById('image-display');
                    imageDisplay.src = img.src;

                    function imgonload() {
                        function hideLoading() {
                            loadingElement.style.display = 'none';
                        }
                        if (!width || !height) {
                            // Use the width and height of the loaded image if not provided
                            width = img.width;
                            height = img.height;
                        }

                        const data = [{
                            x: [],
                            y: [],
                            z: [],
                            mode: 'markers',
                            type: 'scatter3d',
                            marker: {
                                size: 5,
                                color: [],  // Array to store colors for each point
                                opacity: 0.5,  // Set opacity for every point
                                colorscale: 'Viridis'
                            },
                            hoverinfo: 'none'  // Disable tooltips
                        }];

                        // Create a single canvas element and draw the image once
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d', { willReadFrequently: true });
                        ctx.drawImage(img, 0, 0, width, height);

                        // Loop through all pixels and sample pixel data
                        for (let y = 0; y < height; y++) {
                            for (let x = 0; x < width; x++) {
                                // Sample pixel data from the drawn image
                                const pixel = ctx.getImageData(x, y, 1, 1).data;

                                // Add coordinates to the single trace
                                data[0].x.push(pixel[0]);  // Red component as x
                                data[0].y.push(pixel[1]);  // Green component as y
                                data[0].z.push(pixel[2]);  // Blue component as z

                                // Add color for each point
                                data[0].marker.color.push(`rgb(${pixel[0]}, ${pixel[1]}, ${pixel[2]})`);
                            }
                        }

                        const layout = {
                            scene: {
                                xaxis: { title: 'Red', range: [0, 255] },
                                yaxis: { title: 'Green', range: [0, 255] },
                                zaxis: { title: 'Blue', range: [0, 255] }
                            }
                        };

                        // Display the 3D scatter plot
                        Plotly.newPlot('scatter-plot', data, layout).then(function () {
                            requestAnimationFrame(hideLoading);
                        });

                    };

                    requestAnimationFrame(imgonload);
                }
                requestAnimationFrame(showImage);
            };

            img.src = imagePath;
        }

        // Get the image path from the query string using URLSearchParams
        const queryParams = new URLSearchParams(window.location.search);
        const imagePathFromQueryString = queryParams.get('image');
        const widthFromQueryString = parseInt(queryParams.get('width'));
        const heightFromQueryString = parseInt(queryParams.get('height'));

        if (imagePathFromQueryString) {
            // Call the function with the image path
            console.log("ARGHH!")
            createScatterPlotFromImage(imagePathFromQueryString, widthFromQueryString, heightFromQueryString);
        } else {
            console.error('Image path not provided in the query string.');
        }

        // Resize the plot when the window is resized
        window.addEventListener('resize', function () {
            Plotly.Plots.resize('scatter-plot');
        });
    </script>

</body>

</html>