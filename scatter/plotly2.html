<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <title>3D Scatter Plot from Image</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }

        #scatter-plot {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
        }

        #image-display {
            position: absolute;
            top: 0;
            left: 0;
            margin: 20px;
            max-width: 30%; /* Adjust the maximum width of the image */
        }
    </style>
</head>
<body>

<div id="scatter-plot"></div>
<img id="image-display" />

<script>
    // Function to load the image and create 3D scatter plot with Plotly
    function createScatterPlotFromImage(imagePath, width, height) {
        const img = new Image();

        img.onload = function() {
            if (!width || !height) {
                // Use the width and height of the loaded image if not provided
                width = img.width;
                height = img.height;
            }

            const data = [{
                x: [],
                y: [],
                z: [],
                mode: 'markers',
                type: 'scatter3d',
                marker: {
                    size: 5,
                    color: [],  // Array to store colors for each point
                    opacity: 0.5,  // Set opacity for every point
                    colorscale: 'Viridis'
                },
                hoverinfo: 'none'  // Disable tooltips
            }];

            // Create a single canvas element and draw the image once
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d', { willReadFrequently: true });
            ctx.drawImage(img, 0, 0, width, height);

            // Loop through all pixels and sample pixel data
            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    // Sample pixel data from the drawn image
                    const pixel = ctx.getImageData(x, y, 1, 1).data;

                    // Add coordinates to the single trace
                    data[0].x.push(pixel[0]);  // Red component as x
                    data[0].y.push(pixel[1]);  // Green component as y
                    data[0].z.push(pixel[2]);  // Blue component as z

                    // Add color for each point
                    data[0].marker.color.push(`rgb(${pixel[0]}, ${pixel[1]}, ${pixel[2]})`);
                }
            }

            const layout = {
                scene: {
                    xaxis: { title: 'Red', range: [0, 255] },
                    yaxis: { title: 'Green', range: [0, 255] },
                    zaxis: { title: 'Blue', range: [0, 255] }
                }
            };

            // Display the 3D scatter plot
            Plotly.newPlot('scatter-plot', data, layout);

            // Display the image
            const imageDisplay = document.getElementById('image-display');
            imageDisplay.src = img.src;
        };

        img.src = imagePath;
    }

    // Get the image path from the query string using URLSearchParams
    const queryParams = new URLSearchParams(window.location.search);
    const imagePathFromQueryString = queryParams.get('image');

    if (imagePathFromQueryString) {
        // Call the function with the image path
        createScatterPlotFromImage(imagePathFromQueryString);
    } else {
        console.error('Image path not provided in the query string.');
    }

    // Resize the plot when the window is resized
    window.addEventListener('resize', function() {
        Plotly.Plots.resize('scatter-plot');
    });
</script>

</body>
</html>
