<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/9.5.0/math.min.js"></script>
    <title>Multiple Linear Regression with Plotly</title>
</head>
<body>

<div id="scatter-plot"></div>

<script>
// Function to perform regression and update the plot
function performRegression() {
    const X1 = Array.from({ length: 100 }, () => Math.random());
    const X2 = Array.from({ length: 100 }, () => Math.random());
    const Y = X1.map((x1, i) => 2 * x1 + 3 * X2[i] + /* 0.5 * */ 3 * Math.random());

    // Perform regression on the server
    fetch('/perform_regression', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ X1, X2, Y }),
    })
    .then(response => response.json())
    .then(coefficients => {
        // Display the results
        plotResults(X1, X2, Y, coefficients);
    })
    .catch(error => console.error('Error:', error));
}

// Function to plot the scatter plot and regression plane
function plotResults(X1, X2, Y, coefficients) {
    const scatterPlot = {
        x: X1,
        y: X2,
        z: Y,
        mode: 'markers',
        type: 'scatter3d',
        marker: { size: 5, color: 'red' },
        name: 'Data Points'
    };

    // Create meshgrid
    const nPoints = 10;
    const X1_plane = linspace(Math.min(...X1), Math.max(...X1), nPoints);
    const X2_plane = linspace(Math.min(...X2), Math.max(...X2), nPoints);

    const meshgrid = [];
    for (let i = 0; i < nPoints; i++) {
        for (let j = 0; j < nPoints; j++) {
            meshgrid.push([X1_plane[i], X2_plane[j]]);
        }
    }

    const Y_plane = meshgrid.map(point => coefficients.intercept + coefficients.coef_X1 * point[0] + coefficients.coef_X2 * point[1]);

    const regressionPlane = {
        x: X1_plane,
        y: X2_plane,
        z: math.reshape(Y_plane, [nPoints, nPoints]),
        type: 'surface',
        opacity: 0.5,
        contours: {
            z: {
                show: true,
                usecolormap: true,
                highlightcolor: "#42f462",
                project: { z: true }
            }
        },
        colorscale: 'Viridis',
        name: 'Regression Plane'
    };

    const layout = {
        scene: {
            xaxis: { title: 'X1' },
            yaxis: { title: 'X2' },
            zaxis: { title: 'Y' }
        }
    };

    Plotly.newPlot('scatter-plot', [scatterPlot, regressionPlane], layout);
}

// Utility function to create a linspace array
function linspace(start, end, n) {
    const step = (end - start) / (n - 1);
    return Array.from({ length: n }, (_, i) => start + i * step);
}


// Perform regression on page load
performRegression();
</script>

</body>
</html>
