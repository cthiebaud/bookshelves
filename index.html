<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bookshelves</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <style>
        hr {
            margin: 0.2rem;
        }

        figure:after {
            content: "";
            /* This is necessary for the pseudo element to work. */
            display: block;
            /* This will put the pseudo element on its own line. */
            margin: 0 auto;
            /* This will center the border. */
            width: 84%;
            /* Change this to whatever width you want. */
            padding-top: 20px;
            /* This creates some space between the element and the border. */
            border-bottom: 1px solid lightgray;
            /* This creates the border. Replace black with whatever color you want. */
        }

        .figure-img {
            margin-bottom: 0.25rem;
        }

        .category {
            text-align: center;
        }

        #howmuch #total,
        #howmuch #current {
            font-size: 24px;
        }

        #howmuch #percent {
            font-size: 16px;
        }

        #howmuch #circle_with_cross {
            font-size: 20px;
            color: #c9c9c9;
            display: none;
            margin: -6px 0 0 0;
            padding: 0;
            border: none;
        }

        #langage .btn {
            font-size: 16px;
        }

        #location .btn {
            font-size: 14px;
        }

        #tags .btn,
        #color .btn,
        #date .btn {
            font-size: 12px;
        }

        .active>.btn:not(.active) {
            opacity: .5;
        }

        .color.btn {
            margin: 0;
            padding: 6px;
        }

        .color_black {
            color: black;
        }

        .color_white {
            color: white;
        }

        .color_gray {
            color: gray;
        }

        .color_red {
            color: red;
        }

        .color_yellow {
            color: yellow;
        }

        .color_green {
            color: green;
        }

        .color_cyan {
            color: cyan;
        }

        .color_blue {
            color: blue;
        }

        .color_magenta {
            color: magenta;
        }

        .btn:not(.active):hover {
            border: 1px dashed #a0a0a0;
        }

        .sgl {
            display: inline-block;
            position: relative;
            width: 14px;
            height: 16px;
            z-index: 1;
        }

        .sgl::after {
            content: "";
            background-image: url(/svg/bronze.857-b-last-try.svg);
            background-repeat: no-repeat;
            background-size: cover;
            overflow: hidden;
            opacity: 0.5;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            position: absolute;
            z-index: -1;
        }

        .titleBar {
            display: flex;
            border: .667px dashed gray;
            min-height: 6px;
            margin: 0;
            padding: 0;
        }
    </style>
</head>

<body>
    <div id="container" class="container-fluid">
        <div id="howmuch" class="category" style="position: relative;">
            <span id="total" class="float-start" style="display:none;"></span>
            <span id="current">&hellip;</span>
            <span id="percent"></span>
            <span id="circle_with_cross" class="btn" style="">ⓧ</span>
        </div>
        <hr>
        <div id="location" class="category">
            <a href="#" id="saint-lazare-de-savene" class="btn" role="button" data-bs-toggle="button" data-tags="saint-lazare-de-savene">
                <span style="font-size:smaller">San Lazzaro</span>
                <span id="c-saint-lazare-de-savene"></span>
                ⥣
            </a>
            <a href="#" id="saint-jean-lipion" class="btn" role="button" data-bs-toggle="button" data-tags="saint-jean-lipion">
                ⥥
                <span id="c-saint-jean-lipion"></span>
                <span style="font-size:smaller">San Giovanni</span>
                <span class="sgl"></span>
            </a>
        </div>
        <hr>
        <div id="langage" class="category">
            <a href="#" id="🇫🇷" class="btn" role="button" data-bs-toggle="button" data-tags="🇫🇷"> 🇫🇷 <span id="c-🇫🇷"></span> </a>
            <a href="#" id="🇮🇹" class="btn" role="button" data-bs-toggle="button" data-tags="🇮🇹"> 🇮🇹 <span id="c-🇮🇹"></span> </a>
            <a href="#" id="🇬🇧" class="btn" role="button" data-bs-toggle="button" data-tags="🇬🇧"> 🇬🇧 <span id="c-🇬🇧"></span> </a>
            <a href="#" id="🇩🇪" class="btn" role="button" data-bs-toggle="button" data-tags="🇩🇪"> 🇩🇪 <span id="c-🇩🇪"></span> </a>
            <a href="#" id="🇵🇹" class="btn" role="button" data-bs-toggle="button" data-tags="🇵🇹"> 🇵🇹 <span id="c-🇵🇹"></span> </a>
            <a href="#" id="🇪🇸" class="btn" role="button" data-bs-toggle="button" data-tags="🇪🇸"> 🇪🇸 <span id="c-🇪🇸"></span> </a>
        </div>
        <hr>
        <div id="tags" class="category">
            <a href="#" id="2_guerre" class="btn" role="button" data-bs-toggle="button" data-tags="nazi">2ᵉ guerre</a>
            <a href="#" id="bach" class="btn" role="button" data-bs-toggle="button" data-tags="bach">Bach</a>
            <a href="#" id="bd" class="btn" role="button" data-bs-toggle="button" data-tags="bd manga tintin tintin_etc">BD</a>
            <a href="#" id="beau_livre" class="btn" role="button" data-bs-toggle="button" data-tags="beau_livre arts arts_bis">Beaux livres</a>
            <a href="#" id="berlusconneries" class="btn" role="button" data-bs-toggle="button" data-tags="berlusconneries">Berlusconneries</a>
            <a href="#" id="biographie" class="btn" role="button" data-bs-toggle="button" data-tags="biographie">Biographie</a>
            <a href="#" id="celine" class="btn" role="button" data-bs-toggle="button" data-tags="celine">Céline</a>
            <a href="#" id="cinema" class="btn" role="button" data-bs-toggle="button" data-tags="cinema">Cinéma</a>
            <a href="#" id="cuisine" class="btn" role="button" data-bs-toggle="button" data-tags="cuisine">Cuisine</a>
            <a href="#" id="chess" class="btn" role="button" data-bs-toggle="button" data-tags="chess">Échecs ♘</a>
            <a href="#" id="editor" class="btn" role="button" data-bs-toggle="button" data-tags="editor">Editeurs</a>
            <a href="#" id="editori" class="btn" role="button" data-bs-toggle="button" data-tags="editori">Editori</a>
            <a href="#" id="enfer" class="btn" role="button" data-bs-toggle="button" data-tags="enfer">Enfer</a>
            <a href="#" id="football" class="btn" role="button" data-bs-toggle="button" data-tags="football">Foot</a>
            <a href="#" id="kafka" class="btn" role="button" data-bs-toggle="button" data-tags="kafka">Kafka</a>
            <a href="#" id="lapleiade" class="btn" role="button" data-bs-toggle="button" data-tags="lapleiade">La Pléiade</a>
            <a href="#" id="mozart" class="btn" role="button" data-bs-toggle="button" data-tags="mozart">Mozart</a>
            <a href="#" id="musique" class="btn" role="button" data-bs-toggle="button" data-tags="music bach mozart">Musique 𝄞</a>
            <a href="#" id="perec" class="btn" role="button" data-bs-toggle="button" data-tags="perec">Perec</a>
            <a href="#" id="philo" class="btn" role="button" data-bs-toggle="button" data-tags="philo">Philo</a>
            <a href="#" id="poche" class="btn" role="button" data-bs-toggle="button" data-tags="poche">Poche</a>
            <a href="#" id="poesie" class="btn" role="button" data-bs-toggle="button" data-tags="poésie rimbaud">Poésie</a>
            <a href="#" id="polar" class="btn" role="button" data-bs-toggle="button" data-tags="polar pdjames">Polar</a>
            <a href="#" id="proust" class="btn" role="button" data-bs-toggle="button" data-tags="proust">Proust</a>
            <a href="#" id="rimbaud" class="btn" role="button" data-bs-toggle="button" data-tags="rimbaud">Rimbaud</a>
            <a href="#" id="roth" class="btn" role="button" data-bs-toggle="button" data-tags="roth">Roth</a>
            <a href="#" id="rowling" class="btn" role="button" data-bs-toggle="button" data-tags="rowling">Rowling</a>
            <a href="#" id="schloss" class="btn" role="button" data-bs-toggle="button" data-tags="schloss">Das Schloß</a>
            <a href="#" id="small" class="btn" role="button" data-bs-toggle="button" data-tags="small">Small</a>
            <a href="#" id="theatre" class="btn" role="button" data-bs-toggle="button" data-tags="théatre">Théatre</a>
            <a href="#" id="tintin" class="btn" role="button" data-bs-toggle="button" data-tags="tintin tintin_etc">Tintin</a>
        </div>
        <hr>
        <div id="color" class="category">
            <a href="#" id="black" class="color btn" role="button" data-bs-toggle="button" data-tags="Black">
                <span class="color_black">⬤</span>
            </a>
            <a href="#" id="white" class="color btn" role="button" data-bs-toggle="button" data-tags="White">
                <span class="color_white">⬤</span>
            </a>
            <a href="#" id="gray" class="color btn" role="button" data-bs-toggle="button" data-tags="Gray">
                <span class="color_gray">⬤</span>
            </a>
            <a href="#" id="red" class="color btn" role="button" data-bs-toggle="button" data-tags="Red">
                <span class="color_red">⬤</span>
            </a>
            <a href="#" id="yellow" class="color btn" role="button" data-bs-toggle="button" data-tags="Yellow">
                <span class="color_yellow">⬤</span>
            </a>
            <a href="#" id="green" class="color btn" role="button" data-bs-toggle="button" data-tags="Green">
                <span class="color_green">⬤</span>
            </a>
            <a href="#" id="cyan" class="color btn" role="button" data-bs-toggle="button" data-tags="Cyan">
                <span class="color_cyan">⬤</span>
            </a>
            <a href="#" id="blue" class="color btn" role="button" data-bs-toggle="button" data-tags="Blue">
                <span class="color_blue">⬤</span>
            </a>
            <a href="#" id="magenta" class="color btn" role="button" data-bs-toggle="button" data-tags="Magenta">
                <span class="color_magenta">⬤</span>
            </a>
            <a href="#" id="rainbow" class="color btn" role="button" data-bs-toggle="button" data-tags="Rainbow">
                <span class="color_rainbow">🌈</span>
            </a>
        </div>
        <hr>
        <div id="date" class="category">
            <a href="#" id="_1400" class="btn" role="button" data-bs-toggle="button"
                data-tags="_1400 _1401 _1402 _1403 _1404 _1405 _1406 _1407 _1408 _1409 _1410 _1411 _1412 _1413 _1414 _1415 _1416 _1417 _1418 _1419 _1420 _1421 _1422 _1423 _1424 _1425 _1426 _1427 _1428 _1429 _1430 _1431 _1432 _1433 _1434 _1435 _1436 _1437 _1438 _1439 _1440 _1441 _1442 _1443 _1444 _1445 _1446 _1447 _1448 _1449 _1450 _1451 _1452 _1453 _1454 _1455 _1456 _1457 _1458 _1459 _1460 _1461 _1462 _1463 _1464 _1465 _1466 _1467 _1468 _1469 _1470 _1471 _1472 _1473 _1474 _1475 _1476 _1477 _1478 _1479 _1480 _1481 _1482 _1483 _1484 _1485 _1486 _1487 _1488 _1489 _1490 _1491 _1492 _1493 _1494 _1495 _1496 _1497 _1498 _1499">1400'</a>
            <a href="#" id="_1500" class="btn" role="button" data-bs-toggle="button"
                data-tags="_1500 _1501 _1502 _1503 _1504 _1505 _1506 _1507 _1508 _1509 _1510 _1511 _1512 _1513 _1514 _1515 _1516 _1517 _1518 _1519 _1520 _1521 _1522 _1523 _1524 _1525 _1526 _1527 _1528 _1529 _1530 _1531 _1532 _1533 _1534 _1535 _1536 _1537 _1538 _1539 _1540 _1541 _1542 _1543 _1544 _1545 _1546 _1547 _1548 _1549 _1550 _1551 _1552 _1553 _1554 _1555 _1556 _1557 _1558 _1559 _1560 _1561 _1562 _1563 _1564 _1565 _1566 _1567 _1568 _1569 _1570 _1571 _1572 _1573 _1574 _1575 _1576 _1577 _1578 _1579 _1580 _1581 _1582 _1583 _1584 _1585 _1586 _1587 _1588 _1589 _1590 _1591 _1592 _1593 _1594 _1595 _1596 _1597 _1598 _1599">1500'</a>
            <a href="#" id="_1600" class="btn" role="button" data-bs-toggle="button"
                data-tags="_1600 _1601 _1602 _1603 _1604 _1605 _1606 _1607 _1608 _1609 _1610 _1611 _1612 _1613 _1614 _1615 _1616 _1617 _1618 _1619 _1620 _1621 _1622 _1623 _1624 _1625 _1626 _1627 _1628 _1629 _1630 _1631 _1632 _1633 _1634 _1635 _1636 _1637 _1638 _1639 _1640 _1641 _1642 _1643 _1644 _1645 _1646 _1647 _1648 _1649 _1650 _1651 _1652 _1653 _1654 _1655 _1656 _1657 _1658 _1659 _1660 _1661 _1662 _1663 _1664 _1665 _1666 _1667 _1668 _1669 _1670 _1671 _1672 _1673 _1674 _1675 _1676 _1677 _1678 _1679 _1680 _1681 _1682 _1683 _1684 _1685 _1686 _1687 _1688 _1689 _1690 _1691 _1692 _1693 _1694 _1695 _1696 _1697 _1698 _1699">1600'</a>
            <a href="#" id="_1700" class="btn" role="button" data-bs-toggle="button"
                data-tags="_1700 _1701 _1702 _1703 _1704 _1705 _1706 _1707 _1708 _1709 _1710 _1711 _1712 _1713 _1714 _1715 _1716 _1717 _1718 _1719 _1720 _1721 _1722 _1723 _1724 _1725 _1726 _1727 _1728 _1729 _1730 _1731 _1732 _1733 _1734 _1735 _1736 _1737 _1738 _1739 _1740 _1741 _1742 _1743 _1744 _1745 _1746 _1747 _1748 _1749 _1750 _1751 _1752 _1753 _1754 _1755 _1756 _1757 _1758 _1759 _1760 _1761 _1762 _1763 _1764 _1765 _1766 _1767 _1768 _1769 _1770 _1771 _1772 _1773 _1774 _1775 _1776 _1777 _1778 _1779 _1780 _1781 _1782 _1783 _1784 _1785 _1786 _1787 _1788 _1789 _1790 _1791 _1792 _1793 _1794 _1795 _1796 _1797 _1798 _1799">1700'</a>
            <a href="#" id="_1800" class="btn" role="button" data-bs-toggle="button"
                data-tags="_1800 _1801 _1802 _1803 _1804 _1805 _1806 _1807 _1808 _1809 _1810 _1811 _1812 _1813 _1814 _1815 _1816 _1817 _1818 _1819 _1820 _1821 _1822 _1823 _1824 _1825 _1826 _1827 _1828 _1829 _1830 _1831 _1832 _1833 _1834 _1835 _1836 _1837 _1838 _1839 _1840 _1841 _1842 _1843 _1844 _1845 _1846 _1847 _1848 _1849 _1850 _1851 _1852 _1853 _1854 _1855 _1856 _1857 _1858 _1859 _1860 _1861 _1862 _1863 _1864 _1865 _1866 _1867 _1868 _1869 _1870 _1871 _1872 _1873 _1874 _1875 _1876 _1877 _1878 _1879 _1880 _1881 _1882 _1883 _1884 _1885 _1886 _1887 _1888 _1889 _1890 _1891 _1892 _1893 _1894 _1895 _1896 _1897 _1898 _1899">1800'</a>
            <!--br-->
            <a href="#" id="_1900" class="btn" role="button" data-bs-toggle="button" data-tags="_1900 _1901 _1902 _1903 _1904 _1905 _1906 _1907 _1908 _1909">1900'</a>
            <a href="#" id="_1910" class="btn" role="button" data-bs-toggle="button" data-tags="_1910 _1911 _1912 _1913 _1914 _1915 _1916 _1917 _1918 _1919">1910'</a>
            <a href="#" id="_1920" class="btn" role="button" data-bs-toggle="button" data-tags="_1920 _1921 _1922 _1923 _1924 _1925 _1926 _1927 _1928 _1929">1920'</a>
            <a href="#" id="_1930" class="btn" role="button" data-bs-toggle="button" data-tags="_1930 _1931 _1932 _1933 _1934 _1935 _1936 _1937 _1938 _1939">1930'</a>
            <a href="#" id="_1940" class="btn" role="button" data-bs-toggle="button" data-tags="_1940 _1941 _1942 _1943 _1944 _1945 _1946 _1947 _1948 _1949">1940'</a>
            <a href="#" id="_1950" class="btn" role="button" data-bs-toggle="button" data-tags="_1950 _1951 _1952 _1953 _1954 _1955 _1956 _1957 _1958 _1959">1950'</a>
            <a href="#" id="_1960" class="btn" role="button" data-bs-toggle="button" data-tags="_1960 _1961 _1962 _1963 _1964 _1965 _1966 _1967 _1968 _1969">1960'</a>
            <a href="#" id="_1970" class="btn" role="button" data-bs-toggle="button" data-tags="_1970 _1971 _1972 _1973 _1974 _1975 _1976 _1977 _1978 _1979">1970'</a>
            <a href="#" id="_1980" class="btn" role="button" data-bs-toggle="button" data-tags="_1980 _1981 _1982 _1983 _1984 _1985 _1986 _1987 _1988 _1989">1980'</a>
            <a href="#" id="_1990" class="btn" role="button" data-bs-toggle="button" data-tags="_1990 _1991 _1992 _1993 _1994 _1995 _1996 _1997 _1998 _1999">1990'</a>
            <a href="#" id="_2000" class="btn" role="button" data-bs-toggle="button" data-tags="_2000 _2001 _2002 _2003 _2004 _2005 _2006 _2007 _2008 _2009">2000'</a>
            <!--br-->
            <a href="#" id="_2010" class="btn" role="button" data-bs-toggle="button" data-tags="_2010">2010</a>
            <a href="#" id="_2011" class="btn" role="button" data-bs-toggle="button" data-tags="_2011">2011</a>
            <a href="#" id="_2012" class="btn" role="button" data-bs-toggle="button" data-tags="_2012">2012</a>
            <a href="#" id="_2013" class="btn" role="button" data-bs-toggle="button" data-tags="_2013">2013</a>
            <a href="#" id="_2014" class="btn" role="button" data-bs-toggle="button" data-tags="_2014">2014</a>
            <a href="#" id="_2015" class="btn" role="button" data-bs-toggle="button" data-tags="_2015">2015</a>
            <a href="#" id="_2016" class="btn" role="button" data-bs-toggle="button" data-tags="_2016">2016</a>
            <a href="#" id="_2017" class="btn" role="button" data-bs-toggle="button" data-tags="_2017">2017</a>
            <a href="#" id="_2018" class="btn" role="button" data-bs-toggle="button" data-tags="_2018">2018</a>
            <a href="#" id="_2019" class="btn" role="button" data-bs-toggle="button" data-tags="_2019">2019</a>
            <a href="#" id="_2020" class="btn" role="button" data-bs-toggle="button" data-tags="_2020">2020</a>
            <a href="#" id="_2021" class="btn" role="button" data-bs-toggle="button" data-tags="_2021">2021</a>
            <a href="#" id="_2022" class="btn" role="button" data-bs-toggle="button" data-tags="_2022">2022</a>
            <a href="#" id="_2023" class="btn" role="button" data-bs-toggle="button" data-tags="_2023">2023</a>
        </div>
        <hr>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@latest/dist/js/bootstrap.min.js"></script>
    <script type="module">
        import jsYaml from 'https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/+esm'
        import acColors from 'https://cdn.jsdelivr.net/npm/ac-colors@1.4.3/+esm'
        import { deltaE } from 'https://cdn.jsdelivr.net/npm/color-delta-e@1.3.0/+esm'
        import colorSpace from 'https://cdn.jsdelivr.net/npm/color-space@2.0.1/+esm'

        const container = document.getElementById("container");
        let entries
        let total_des_totaux = undefined

        function calculateAverageHueHSL(palette) {
            let totalHue = 0;
            let totalWeight = 0;

            for (const color of palette) {
                // Assuming color is in HSL color space
                const hsl = colorSpace.rgb.hsl(color.color)
                totalHue += hsl[0] * color.count;
                totalWeight += color.count;
            }

            const averageHue = totalHue / totalWeight;

            return averageHue;
        }

        function calculateWeightedAverageChroma(palette) {
            let totalWeightedChroma = 0;
            let totalWeight = 0;

            for (const color of palette) {
                // Assuming color is in CIELAB color space
                const lab = colorSpace.rgb.lab(color.color)
                const chroma = Math.sqrt(Math.pow(lab[1], 2) + Math.pow(lab[2], 2))
                const weightedChroma = chroma * color.count;
                totalWeightedChroma += weightedChroma;
                totalWeight += color.count;
            }

            const weightedAverageChroma = totalWeightedChroma / totalWeight;

            return weightedAverageChroma;
        }

        function calculateAverageLuminance(palette) {
            let totalWeightedLuminance = 0;
            let totalWeight = 0;

            for (const color of palette) {
                const lab = colorSpace.rgb.lab(color.color)
                const weightedLuminance = lab[0] * color.count;
                totalWeightedLuminance += weightedLuminance;
                totalWeight += color.count;
            }

            const weightedAverageLuminance = totalWeightedLuminance / totalWeight;

            return weightedAverageLuminance;
        }

        function palette_diversity(palette) {
            // Calculate the color differences between all pairs of colors
            let totalDifference = 0;
            let pairCount = 0;
            const diversity = {}
            let totalWeightedDeltaE = 0
            let weightNorm = 0
            let weightVariance = 0

            // Calculate the mean (average) weight of colors in the set
            let meanWeight = 0;
            for (const color of palette) {
                meanWeight += color.count;
            }
            meanWeight /= palette.length;


            for (let i = 0; i < palette.length; i++) {
                for (let j = i + 1; j < palette.length; j++) {

                    const color1 = palette[i]
                    const color2 = palette[j]

                    // Calculate CIELAB ΔE between the two colors
                    const _deltaE = deltaE(color1.color, color2.color)

                    // Calculate the weighted ΔE for the pair
                    const weightedDeltaE = _deltaE * (color1.count * color2.count)

                    const key = "_" + i + j
                    diversity[key] = weightedDeltaE

                    // Add the weighted ΔE to the total
                    totalWeightedDeltaE += weightedDeltaE

                    // Add the square of the weight to weightNorm
                    weightNorm += Math.pow(color1.count, 2) + Math.pow(color2.count, 2)

                    // Calculate the weight deviation from the mean and add it to the weightVariance
                    let weightDeviation = color1.count - meanWeight;
                    weightVariance += weightDeviation * weightDeviation;
                    weightDeviation = color2.count - meanWeight;
                    weightVariance += weightDeviation * weightDeviation;
                }
            }

            const weightVarianceScalingFactor = 0.1

            // Calculate the average color difference as the diversity indicator
            const diversityIndex = (totalWeightedDeltaE / (1 + weightVariance)) * weightNorm * weightVarianceScalingFactor

            diversity["total"] = diversityIndex

            // console.log('Diversity Indicator:', diversity)

            return diversity
        }


        class Counter {
            total = 0;
            sgl = 0;
            slds = 0;
            en = 0;
            it = 0;
            fr = 0;
            de = 0;
            pt = 0;
            sp = 0;
            count = (entry) => {
                switch (entry.lan) {
                    case '🇬🇧':
                        this.en++
                        break;
                    case '🇮🇹':
                        this.it++
                        break;
                    case '🇫🇷':
                        this.fr++
                        break;
                    case '🇩🇪':
                        this.de++
                        break;
                    case '🇵🇹':
                        this.pt++
                        break;
                    case '🇪🇸':
                        this.sp++
                        break;
                    default:
                        console.error("missing lan property", entry);
                }
                if (entry.where.includes("lipion")) {
                    this.sgl++
                } else {
                    this.slds++
                }
                this.total++
            };

            display = () => {
                if (typeof total_des_totaux === "undefined") {
                    total_des_totaux = this.total
                }
                var s = Number(this.total / total_des_totaux).toLocaleString(undefined, { style: 'percent', minimumFractionDigits: 1 });
                document.getElementById("total").innerHTML = `${total_des_totaux}`
                document.getElementById("current").innerHTML = `${this.total}`
                document.getElementById("percent").innerHTML = `${s}`
                circle_with_cross.style.display = (this.total === total_des_totaux ? "none" : "inline-block")
                // /${total_des_totaux} ⇒ ${s}
                {
                    document.getElementById("c-🇫🇷").innerHTML = `${this.fr}`
                    document.getElementById("c-🇮🇹").innerHTML = `${this.it}`
                    document.getElementById("c-🇬🇧").innerHTML = `${this.en}`
                    document.getElementById("c-🇩🇪").innerHTML = `${this.de}`
                    document.getElementById("c-🇵🇹").innerHTML = `${this.pt}`
                    document.getElementById("c-🇪🇸").innerHTML = `${this.sp}`
                }
                {
                    document.getElementById("c-saint-jean-lipion").innerHTML = `${this.sgl}`
                    document.getElementById("c-saint-lazare-de-savene").innerHTML = `${this.slds}`
                }
            }

        }

        // // Example usage
        // const data = 'rgb[{"color": [232, 203, 175], "count": 17721}, {"color": [137, 61, 62], "count": 4277}, {"color": [246, 230, 207], "count": 44802}]';
        // const extractedDominantColor = extractDominantColor(data);
        // console.log("Dominant Color:", extractedDominantColor);
        function extractDominantColor(palette) {
            // Initialize variables to track the dominant color and its count
            let dominantColor = null;
            let maxCount = -1;

            // Iterate through the color objects
            for (const colorObject of palette) {
                const count = colorObject.count;

                // Check if the current count is higher than the previous maximum
                if (count > maxCount) {
                    maxCount = count;
                    dominantColor = colorObject.color;
                }
            }

            return dominantColor;
        }

        // Define a function to classify the image based on base variables
        function classifyImage(baseVariables) {
            // You can access the base variables to make classification decisions
            const dominantColorHue = baseVariables.dominantColorHSL[0]
            const dominantColorSaturation = baseVariables.dominantColorHSL[1]
            const dominantColorLightness = baseVariables.dominantColorHSL[2] * 255 / 100
            const meanHue = baseVariables.mean_hue;
            const meanSaturation = baseVariables.mean_saturation;
            const meanLightness = baseVariables.mean_lightness;
            const stdHue = baseVariables.std_hue;
            const stdSaturation = baseVariables.std_saturation;
            const stdLightness = baseVariables.std_lightness;

            const monochrome = baseVariables.monochrome
            const monochrome2 = baseVariables.monochrome2

            // Initialize classification as "Unknown"
            let classification = "Unknown";

            // function identifyColorSetType(colorSet) {

            const weightedAverageChroma = calculateWeightedAverageChroma(baseVariables.palette)
            const averageLuminance = calculateAverageLuminance(baseVariables.palette);

            if (averageLuminance < 40 && weightedAverageChroma < 4) {
                return "Black";
            } else if (averageLuminance >= 40 && averageLuminance < 80 && weightedAverageChroma < 3.5) {
                return "Gray";
            } else if (averageLuminance >= 80 && averageLuminance <= 100 && weightedAverageChroma < 3) {
                return "White";
            }

            // rainbow
            if (137491511317 <= baseVariables.palette_diversity.total) {
                return "Rainbow"
            }

            /* if (baseVariables.dominantColor) */ {
                // // Check for specific conditions for each color
                // // WHITES WHITES WHITES WHITES WHITES WHITES WHITES WHITES 
                // if (250 <= dominantColorLightness) {
                //     classification = "White";
                // }
                // else if (240 <= dominantColorLightness && 10 <= stdLightness && meanSaturation < 200) {
                //     classification = "White";
                // }
                // else if (230 <= dominantColorLightness && 30 <= stdLightness && meanSaturation < 140) {
                //     classification = "White";
                // }
                // else if (220 <= dominantColorLightness && 50 <= stdLightness && meanSaturation < 100) {
                //     classification = "White";
                // }
                // else if (210 <= dominantColorLightness && 80 <= stdLightness && meanSaturation < 80) {
                //     classification = "White";
                // }
                // // BLACKS BLACKS BLACKS BLACKS BLACKS BLACKS BLACKS BLACKS 
                // else if (meanLightness < 55 || dominantColorLightness <= 20) {
                //     classification = "Black";
                // }
                // // GRAYS GRAYS GRAYS GRAYS GRAYS GRAYS GRAYS GRAYS GRAYS
                // else if (meanSaturation < 30 && 10 < stdSaturation && stdSaturation < 50) {
                //     classification = "Gray";
                // }
                // // RAINBOW RAINBOW RAINBOW RAINBOW RAINBOW RAINBOW RAINBOW 
                // else if (monochrome2 < 20) { //  && 50 < stdHue && 30 < stdSaturation
                //     classification = "Rainbow"
                // }
                // else 
                {
                    // Define a threshold for hue values (adjust as needed)
                    const averageHue = calculateAverageHueHSL(baseVariables.palette)

                    const hueThresholdLeft = 16;
                    const hueThresholdRight = 14;


                    let averageHue180 = averageHue / 2
                    if (0 <= averageHue180 && averageHue180 < hueThresholdRight) {
                        classification = "Red";
                    } else if ((30 - hueThresholdLeft <= averageHue180 && averageHue180 < 30 + hueThresholdRight)) {
                        classification = "Yellow";
                    } else if (60 - hueThresholdLeft <= averageHue180 && averageHue180 < 60 + hueThresholdRight) {
                        classification = "Green";
                    } else if (90 - hueThresholdLeft <= averageHue180 && averageHue180 < 90 + hueThresholdRight) {
                        classification = "Cyan";
                    } else if (120 - hueThresholdLeft <= averageHue180 && averageHue180 < 120 + hueThresholdRight) {
                        classification = "Blue";
                    } else if (150 - hueThresholdLeft <= averageHue180 && averageHue180 < 150 + hueThresholdRight) {
                        classification = "Magenta";
                    } else {
                        classification = "Red";
                    }
                }
            }

            return classification;
        }


        const categories = {
            langage: undefined,
            location: undefined,
            tags: undefined,
            color: undefined,
            date: undefined
        }

        function selectOrUnselectTag(e) {

            const id = e.currentTarget.id
            const category = e.currentTarget.parentNode.id
            // console.log(category)
            const className = e.currentTarget.className
            const tags = e.currentTarget.dataset.tags.split(' ')

            const allBtns = document.getElementsByClassName("btn")
            for (const btn of allBtns) {
                if (btn.id === id) {
                    continue
                }
                if (btn.parentNode.id !== category) {
                    continue
                }
                btn.classList.remove("active")
            }

            const figures = document.querySelectorAll('figure')
            const c = new Counter()

            if (className.includes('active')) {
                categories[category] = tags
                e.currentTarget.parentNode.classList.add('active')
            } else {
                categories[category] = undefined
                e.currentTarget.parentNode.classList.remove('active')
            }
            console.log(categories)

            // eteins tout
            for (const figure of figures) {
                figure.style.display = "none"
            }

            let selection = ""
            for (let catKey in categories) {
                // build a css selector
                /*if (catKey === "langage" && categories[catKey]) {
                    selection += "." + categories.langage
                } else if (catKey === "location" && categories[catKey]) {
                    selection += "." + categories.location
                } else */ if (categories[catKey]) {
                    let sel = ""
                    let clazzIndex = 0
                    for (const clazz of categories[catKey]) {
                        if (clazzIndex > 0) {
                            sel += ","
                        }
                        sel += selection + "." + clazz
                        clazzIndex++
                    }
                    selection = sel
                }
            }

            console.log(categories, selection)
            if (selection.trim() !== "") {
                const taggeds = document.querySelectorAll(selection)
                for (const tagged of taggeds) {
                    c.count(entries[tagged.dataset.index][1])
                    tagged.style.display = "inline-block"
                }
            } else {
                for (const figure of figures) {
                    c.count(entries[figure.dataset.index][1])
                    figure.style.display = "inline-block"
                }
            }


            c.display()
        }

        const allBtns = document.querySelectorAll(".btn:not(#circle_with_cross)")
        for (const btn of allBtns) {
            btn.addEventListener("click", selectOrUnselectTag);
        }

        circle_with_cross.addEventListener("click", () => {
            const allBtns = document.querySelectorAll(".btn,.category")
            for (const btn of allBtns) {
                btn.classList.remove("active")
            }
            Object.keys(categories).forEach(function (key, index) {
                categories[key] = undefined
            });
            const figures = document.querySelectorAll('figure')
            const c = new Counter()
            for (const figure of figures) {
                c.count(entries[figure.dataset.index][1])
                figure.style.display = "inline-block"
            }
            c.display()
        })

        function blend(index, propert) {
            const key = propert[0]
            const property = propert[1]
            const image_properties = property['image_properties']

            const fig = document.createElement("figure");
            fig.dataset.index = index
            fig.classList.add("figure")
            fig.style = "padding: 10px; max-width: 164px" // max-width: 158px;
            for (const tagIndex in property.tags) {
                fig.classList.add(property.tags[tagIndex])
            }

            fig.classList.add(classifyImage(property.image_properties.properties))
            fig.classList.add(property.where)
            fig.id = key

            const img = document.createElement("img");
            if (!property['image_path']) {
                console.log("image_path not defined", property)
            }
            img.src = property['image_path'] // .replace("thumbs", "thumbs2")
            img.classList.add("figure-img")
            img.classList.add("img-fluid")

            const goodreads_link = document.createElement("a");
            goodreads_link.target = "_goodreads"
            goodreads_link.href = `https://www.goodreads.com/book/isbn/${key}`
            goodreads_link.appendChild(img)

            const figcaption = document.createElement("figcaption");
            figcaption.classList.add("figure-caption")
            figcaption.classList.add("text-wrap")
            let figcaptionstyle = `width: 100%;` // ${bg};
            figcaption.style = figcaptionstyle

            let lan = property['lan'] || '';
            if (!property['de']) {
                console.log(property)
            }
            let author = property['de'].split(/ \(/)[0];
            let title = property['title']
            let where = property['where']
            const authorE = document.createTextNode(author);
            const titleE = document.createTextNode(title);
            const titleSPAN = document.createElement("span");
            titleSPAN.appendChild(titleE)
            titleSPAN.style = "font-size:smaller;"
            const titleBar = document.createElement("div");
            titleBar.classList.add("titleBar")

            if (where.includes("lipion")) {
                const float1 = document.createElement("span");
                float1.classList.add("float-end")
                float1.style = "color: #b9e537; font-size: 14pt; font-weight: bold;"
                const sgl = document.createElement("span");
                sgl.classList.add("sgl")
                /*
                <span class="sgl"></span>
                const flag = document.createTextNode('●'); // 
                */
                float1.appendChild(sgl)
                figcaption.appendChild(float1)
            } {
                const text = document.createTextNode(lan);
                const float = document.createElement("span");
                float.classList.add("float-end")
                float.appendChild(text)
                float.style = "font-size: larger;"
                if (false) {
                    titleSPAN.appendChild(float)
                }
            }
            let spy
            {
                property.image_properties.properties.palette.forEach(e => {
                    let color = document.createElement("div")
                    let bg = `rgb(${e.color})`
                    let width = 100 * (e.count / property.image_properties.properties.paletteSize)
                    color.style = `display:inline-block; height: 6px; width: ${width}%; background: ${bg}`
                    titleBar.appendChild(color)
                })

                const decimals = 0
                const text0 = document.createTextNode(`
_H: ${image_properties.properties.dominantColorHSL[0].toFixed(decimals).padStart(3, '0')}
_S: ${image_properties.properties.dominantColorHSL[1].toFixed(decimals).padStart(3, '0')}
_L: ${image_properties.properties.dominantColorHSL[2].toFixed(decimals).padStart(3, '0')}
`)
                const text = document.createTextNode(`
μH: ${image_properties.properties.mean_hue.toFixed(decimals).padStart(3, '0')}
μS: ${image_properties.properties.mean_saturation.toFixed(decimals).padStart(3, '0')}
μL: ${image_properties.properties.mean_lightness.toFixed(decimals).padStart(3, '0')}
`)
                const text2 = document.createTextNode(`
σH: ${image_properties.properties.std_hue.toFixed(decimals).padStart(3, '0')}
σS: ${image_properties.properties.std_saturation.toFixed(decimals).padStart(3, '0')}
σL: ${image_properties.properties.std_lightness.toFixed(decimals).padStart(3, '0')}
`)
                const text3 = document.createTextNode(`
mono: ${image_properties.properties.monochrome}
`)
                const text4 = document.createTextNode(`
mono2: ${image_properties.properties.monochrome2}
`)
                const text5 = document.createTextNode(`
${image_properties.properties.palette_diversity["_01"].toFixed(0)} +
${image_properties.properties.palette_diversity["_02"].toFixed(0)} +
${image_properties.properties.palette_diversity["_12"].toFixed(0)} =
${image_properties.properties.palette_diversity.total.toFixed(0)}
`)
                spy = document.createElement("div");
                // div.classList.add("float-end")
                spy.style = "font-size: 9.5px; overflow-wrap: anywhere; font-family: monospace, monospace;"// font-family: monospace, monospace;
                spy.appendChild(text0)
                spy.appendChild(document.createElement("br"))
                spy.appendChild(text)
                spy.appendChild(document.createElement("br"))
                spy.appendChild(text2)
                spy.appendChild(document.createElement("br"))
                spy.appendChild(text3)
                spy.appendChild(document.createElement("br"))
                spy.appendChild(text4)
                spy.appendChild(document.createElement("br"))
                spy.appendChild(text5)
            }
            figcaption.appendChild(authorE)
            figcaption.appendChild(document.createElement("br"))
            figcaption.appendChild(titleSPAN)
            if (true) {
                figcaption.appendChild(spy)
            }
            figcaption.appendChild(titleBar)
            fig.appendChild(goodreads_link)
            fig.appendChild(figcaption)
            container.appendChild(fig)
        }

        function updateDisplay(text) {
            const doc = jsYaml.load(text, 'utf8')

            entries = Object.entries(doc);

            for (let entry in entries) {
                const key = entries[entry][0]
                const property = entries[entry][1]
                property.image_properties.properties.palette = JSON.parse(property.image_properties.properties.most_common.replaceAll("'", '"'))
                property.image_properties.properties.palette.sort((a, b) => b.count - a.count)
                property.image_properties.properties.paletteSize = property.image_properties.properties.palette.reduce((accumulator, currentValue) => accumulator + currentValue.count, 0)

                const dominantColor = property.image_properties.properties.palette[0].color;
                const dominantColorHSL = acColors.rgbToHsl(dominantColor)
                property.image_properties.properties.hue = dominantColorHSL[0]
                property.image_properties.properties.saturation = dominantColorHSL[1]
                property.image_properties.properties.lightness = dominantColorHSL[2]

                property.image_properties.properties.dominantColor = dominantColor
                property.image_properties.properties.dominantColorHSL = dominantColorHSL
                console.log(key)
                property.image_properties.properties.palette_diversity = palette_diversity(property.image_properties.properties.palette)
            }

            entries.sort((a, b) => {
                try {
                    const palA = +a[1].image_properties.properties.palette_diversity.total
                    const palB = +b[1].image_properties.properties.palette_diversity.total
                    const monoA = +a[1].image_properties.properties.monochrome2
                    const monoB = +b[1].image_properties.properties.monochrome2
                    const A = +a[1].image_properties.properties.lightness
                    const B = +b[1].image_properties.properties.lightness
                    const lumA = +a[1].image_properties.properties.mean_lightness
                    const lumB = +b[1].image_properties.properties.mean_lightness
                    const stdLumA = +a[1].image_properties.properties.std_lightness
                    const stdLumB = +b[1].image_properties.properties.std_lightness
                    let critA
                    let critB
                    /* {
                        critA = palA
                        critB = palB
                        if (critA != critB) {
                            return critA - critB
                        }
                    }
                    {
                        critA = lumA
                        critB = lumB
                        if (critA != critB) {
                            return critB - critA
                        }
                    }
                    {
                        critA = stdLumA
                        critB = stdLumB
                        if (critA != critB) {
                            return critB - critA
                        }
                    }
                    */

                    const nameA = a[1].de.toUpperCase().split(/ \(/)[0]
                    const nameB = b[1].de.toUpperCase().split(/ \(/)[0]
                    const splitA = nameA.split(/ /)
                    const splitB = nameB.split(/ /)
                    const lastnameA = splitA[splitA.length - 1]
                    const lastnameB = splitB[splitB.length - 1]
                    const lastnameDifference = lastnameA.localeCompare(lastnameB)
                    if (lastnameDifference !== 0) {
                        return lastnameDifference
                    }
                    const nameDifference = nameA.localeCompare(nameB)
                    if (nameDifference !== 0) {
                        return nameDifference
                    }
                    if (typeof a[1].title === "undefined" || typeof b[1].title === "undefined") {
                        console.log("boum!")
                    }
                    const titleA = a[1].title.toUpperCase()
                    const titleB = b[1].title.toUpperCase()
                    return titleA.localeCompare(titleB)
                } catch (error) {
                    console.error(a, b)
                }
            })

            const c = new Counter();
            for (const property in entries) {
                const enableSkip = undefined // "tintin" // "Kafka" // "Perec" // 
                let skip = typeof enableSkip !== "undefined"
                if (typeof entries[property][1].tags !== "undefined") {
                    if (enableSkip) {
                        skip = !entries[property][1].tags.includes(enableSkip)
                    }
                    if (entries[property][1].tags.includes("verboten")) {
                        skip = true
                        console.log("SKIP", entries[property][1].de, entries[property][1].tags)
                    }
                }

                if (!skip) {
                    const entry = entries[property]
                    blend(property, entry)
                    c.count(entry[1])
                } else {
                    // console.log(entries[property][1])
                }

            }
            c.display()
        }

        function fetchData() {
            const xhr = new XMLHttpRequest()
            xhr.open("GET", "everything.yaml", true)
            xhr.onload = () => {
                updateDisplay(xhr.response)
            };
            xhr.send()
        }

        fetchData()

    </script>
</body>

</html>