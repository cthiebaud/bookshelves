<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monochromatic Score</title>
    <!-- Include robust-regression library -->
    <script type="module">
        import regression from 'https://cdn.jsdelivr.net/npm/regression@latest/+esm'
        import * as d3 from 'https://cdn.skypack.dev/d3@7.0.0'

        function rgbToLab(rgb) {
            // Convert RGB to Lab
            var r = rgb[0] / 255.0;
            var g = rgb[1] / 255.0;
            var b = rgb[2] / 255.0;

            r = r > 0.04045 ? Math.pow((r + 0.055) / 1.055, 2.4) : r / 12.92;
            g = g > 0.04045 ? Math.pow((g + 0.055) / 1.055, 2.4) : g / 12.92;
            b = b > 0.04045 ? Math.pow((b + 0.055) / 1.055, 2.4) : b / 12.92;

            r *= 100.0;
            g *= 100.0;
            b *= 100.0;

            var x = r * 0.4124564 + g * 0.3575761 + b * 0.1804375;
            var y = r * 0.2126729 + g * 0.7151522 + b * 0.0721750;
            var z = r * 0.0193339 + g * 0.1191920 + b * 0.9503041;

            x = x / 95.047;
            y = y / 100.000;
            z = z / 108.883;

            x = x > 0.008856 ? Math.pow(x, 1.0 / 3.0) : (903.3 * x + 16.0) / 116.0;
            y = y > 0.008856 ? Math.pow(y, 1.0 / 3.0) : (903.3 * y + 16.0) / 116.0;
            z = z > 0.008856 ? Math.pow(z, 1.0 / 3.0) : (903.3 * z + 16.0) / 116.0;

            var l = (116.0 * y) - 16.0;
            var a = (x - y) * 500.0;
            var b = (y - z) * 200.0;

            return [l, a, b];
        }

        function labToRgb(lab) {
            // Convert Lab to RGB
            var y = (lab[0] + 16.0) / 116.0;
            var x = lab[1] / 500.0 + y;
            var z = y - lab[2] / 200.0;

            y = Math.pow(y, 3.0) > 0.008856 ? Math.pow(y, 3.0) : (y - 16.0 / 116.0) / 7.787;
            x = Math.pow(x, 3.0) > 0.008856 ? Math.pow(x, 3.0) : (x - 16.0 / 116.0) / 7.787;
            z = Math.pow(z, 3.0) > 0.008856 ? Math.pow(z, 3.0) : (z - 16.0 / 116.0) / 7.787;

            var r = x * 95.047;
            var g = y * 100.000;
            var b = z * 108.883;

            r = r > 0.0031308 ? (1.055 * Math.pow(r, 1.0 / 2.4) - 0.055) : r * 12.92;
            g = g > 0.0031308 ? (1.055 * Math.pow(g, 1.0 / 2.4) - 0.055) : g * 12.92;
            b = b > 0.0031308 ? (1.055 * Math.pow(b, 1.0 / 2.4) - 0.055) : b * 12.92;

            return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];
        }

        function computeMonochromaticScore(rgbArray) {
            // Apply weights to Lab channels
            var labArray = rgbArray.map(rgb => rgbToLab(rgb));
            labArray.forEach(lab => lab[0] *= 0.5);  // Lightness channel weight

            // Extract x and y values
            var xValues = labArray.map(point => point[0]);
            var yValues = labArray.map(point => point[1]);

            // Fit a linear regression
            var result = regression.linear([xValues, yValues]);

            // Access the coefficients of the linear regression
            var coefficients = result.equation;

            // Use the coefficients as needed

            // Calculate the least squares error
            var mse = meanSquaredError(labArray, coefficients);

            // Define a threshold for monochromatic score
            var threshold = 0.0001;  // You may need to adjust this based on your specific use case

            // Determine the monochromatic score
            var monochromaticScore = mse < threshold ? "Monochromatic" : "Colorful";

            console.log("Monochromatic Score:", monochromaticScore);
            console.log("Mean Squared Error:", mse);

            // Return the results
            return {
                monochromaticScore: monochromaticScore,
                mse: mse
            };
        }

        function meanSquaredError(labArray, coefficients) {
            // Predicted y values based on linear regression
            var predictedYValues = labArray.map(point => coefficients[0] + coefficients[1] * point[0]);

            // Calculate mean squared error
            var sumSquaredDifferences = 0;
            for (var i = 0; i < labArray.length; i++) {
                var diff = labArray[i][1] - predictedYValues[i];
                sumSquaredDifferences += diff * diff;
            }

            return sumSquaredDifferences / labArray.length;
        }

        window.handleImageUpload = function () {
            var input = document.getElementById('imageInput');
            var img = document.getElementById('selectedImage');

            var reader = new FileReader();

            reader.onload = function (e) {
                img.src = e.target.result;

                img.onload = function () {
                    // Get the pixel data from the image
                    var canvas = document.createElement('canvas');
                    var ctx = canvas.getContext('2d');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0, img.width, img.height);
                    var imageData = ctx.getImageData(0, 0, img.width, img.height);

                    // Convert pixel data to RGB array
                    var rgbArray = [];
                    for (var i = 0; i < imageData.data.length; i += 4) {
                        var rgb = [imageData.data[i], imageData.data[i + 1], imageData.data[i + 2]];
                        rgbArray.push(rgb);
                    }

                    // Compute monochromatic score
                    var result = computeMonochromaticScore(rgbArray);
                    console.log("Monochromatic Score:", result.monochromaticScore);
                    console.log("Mean Squared Error:", result.mse);
                };
            };

            // Read the selected image file
            reader.readAsDataURL(input.files[0]);
        }
    </script>
</head>

<body>
    <input type="file" id="imageInput" onchange="handleImageUpload()">
    <br>
    <img id="selectedImage" style="max-width: 300px; margin-top: 10px;">
</body>

</html>
